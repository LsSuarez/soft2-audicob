@model Audicob.Models.ViewModels.Cobranza.EstadoCuentaViewModel

@{
    ViewData["Title"] = "Estado de Cuenta";
}

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center bg-primary text-white rounded-top">
                    <h1 class="h3 mb-2">
                        <i class="fas fa-file-invoice-dollar me-2"></i>
                        SISTEMA DE COBRANZA AUDICOB
                    </h1>
                    <p class="mb-0 opacity-75">Estado de Cuenta Detallado</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas -->
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <!-- Sidebar con información del cliente -->
        <div class="col-lg-3 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-circle me-2"></i>
                        Información del Cliente
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="avatar-circle bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold">@Model.Cliente</h6>
                            <small class="text-muted">Cliente</small>
                        </div>
                    </div>
                    <hr>
                    <div class="client-info">
                        <p class="mb-2">
                            <i class="fas fa-calendar-alt text-primary me-2"></i>
                            <strong>Fecha:</strong> @Model.Fecha.ToString("dd/MM/yyyy")
                        </p>
                        <p class="mb-2">
                            <i class="fas fa-clock text-primary me-2"></i>
                            <strong>Hora:</strong> @Model.Fecha.ToString("HH:mm")
                        </p>
                    </div>
                </div>
            </div>

            <!-- Acciones Rápidas -->
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>
                        Acciones Rápidas
                    </h6>
                </div>
                <div class="card-body">
                    <!-- CORRECCIÓN: Form correctamente cerrado -->
                    <form asp-controller="Cliente" asp-action="DescargarEstadoCuenta" method="post" class="mb-3">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-download me-2"></i> Descargar PDF
                        </button>
                    </form>

                    <a href="@Url.Action("DetalleDeudaTotal")" class="btn btn-outline-primary w-100 mb-2">
                        <i class="fas fa-credit-card me-2"></i>
                        Realizar Pago
                    </a>
                    <a href="@Url.Action("Dashboard")" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Volver al Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- Contenido Principal -->
        <div class="col-lg-9">
            <!-- Resumen de Deuda -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-gradient-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Resumen de Deuda
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="stat-card bg-danger text-white rounded p-3 text-center">
                                <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                                <h4 class="mb-1">@Model.TotalDeuda.ToString("C", System.Globalization.CultureInfo.CurrentCulture)</h4>
                                <small>Total Deuda</small>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="stat-card bg-info text-white rounded p-3 text-center">
                                <i class="fas fa-landmark fa-2x mb-2"></i>
                                <h4 class="mb-1">@Model.Capital.ToString("C", System.Globalization.CultureInfo.CurrentCulture)</h4>
                                <small>Capital</small>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="stat-card bg-warning text-dark rounded p-3 text-center">
                                <i class="fas fa-percentage fa-2x mb-2"></i>
                                <h4 class="mb-1">@Model.Intereses.ToString("C", System.Globalization.CultureInfo.CurrentCulture)</h4>
                                <small>Intereses</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Saldos y Movimientos -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body text-center">
                            <div class="saldo-icon bg-primary text-white rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                <i class="fas fa-arrow-left fa-2x"></i>
                            </div>
                            <h5 class="text-muted">SALDO ANTERIOR</h5>
                            <h3 class="text-primary fw-bold">@Model.SaldoAnterior.ToString("C", System.Globalization.CultureInfo.CurrentCulture)</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body text-center">
                            <div class="saldo-icon bg-success text-white rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                <i class="fas fa-arrow-right fa-2x"></i>
                            </div>
                            <h5 class="text-muted">SALDO ACTUAL</h5>
                            <h3 class="text-success fw-bold">@Model.SaldoActual.ToString("C", System.Globalization.CultureInfo.CurrentCulture)</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body text-center">
                            <div class="saldo-icon bg-info text-white rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                <i class="fas fa-exchange-alt fa-2x"></i>
                            </div>
                            <h5 class="text-muted">MOVIMIENTOS</h5>
                            <div class="d-flex justify-content-around">
                                <div>
                                    <h6 class="text-success">@Model.TotalAbonos.ToString("C", System.Globalization.CultureInfo.CurrentCulture)</h6>
                                    <small>Abonos</small>
                                </div>
                                <div>
                                    <h6 class="text-danger">@Model.TotalCargos.ToString("C", System.Globalization.CultureInfo.CurrentCulture)</h6>
                                    <small>Cargos</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter me-2"></i>
                        Filtros de Búsqueda
                    </h5>
                </div>
                <div class="card-body">
                    <form method="get" asp-action="EstadoCuenta" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Buscar por descripción</label>
                            <input type="text" name="searchTerm" class="form-control" placeholder="Ingrese término de búsqueda..." value="@Model.SearchTerm">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Fecha desde</label>
                            <input type="date" name="fechaDesde" class="form-control" value="@(Model.FechaDesde?.ToString("yyyy-MM-dd"))">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Fecha hasta</label>
                            <input type="date" name="fechaHasta" class="form-control" value="@(Model.FechaHasta?.ToString("yyyy-MM-dd"))">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search me-2"></i>
                                Filtrar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Historial de Transacciones -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-gradient-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-history me-2"></i>
                            Historial de Transacciones
                        </h5>
                        <span class="badge bg-light text-dark">
                            @Model.HistorialTransacciones.Count transacciones
                        </span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">
                                        <i class="fas fa-calendar me-2"></i>
                                        Fecha
                                    </th>
                                    <th>
                                        <i class="fas fa-file-alt me-2"></i>
                                        Descripción
                                    </th>
                                    <th class="text-end">
                                        <i class="fas fa-dollar-sign me-2"></i>
                                        Monto
                                    </th>
                                    <th class="text-center">
                                        <i class="fas fa-tag me-2"></i>
                                        Estado
                                    </th>
                                    <th class="text-center pe-4">
                                        <i class="fas fa-cogs me-2"></i>
                                        Acciones
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.HistorialTransacciones.Any())
                                {
                                    @foreach (var transaccion in Model.HistorialTransacciones)
                                    {
                                        <tr>
                                            <td class="ps-4 fw-bold">
                                                @transaccion.Fecha
                                            </td>
                                            <td>
                                                <div>
                                                    <strong>@transaccion.Descripcion</strong>
                                                </div>
                                            </td>
                                            <td class="text-end fw-bold @(transaccion.Monto >= 0 ? "text-success" : "text-danger")">
                                                @(transaccion.Monto >= 0 ? "+" : "")@transaccion.Monto.ToString("C", System.Globalization.CultureInfo.CurrentCulture)
                                            </td>
                                            <td class="text-center">
                                                <span class="badge @GetEstadoBadgeClass(transaccion.Estado)">
                                                    @transaccion.Estado
                                                </span>
                                            </td>
                                            <td class="text-center pe-4">
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <a href="@Url.Action("VerComprobante", "Abono", new { transaccionId = transaccion.Id })" 
                                                       class="btn btn-outline-info" 
                                                       title="Ver Comprobante">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <a href="@Url.Action("ReenviarComprobante", "Abono", new { metodo = "email", transaccionId = transaccion.Id })" 
                                                       class="btn btn-outline-success" 
                                                       title="Enviar por Email">
                                                        <i class="fas fa-envelope"></i>
                                                    </a>
                                                    <a href="@Url.Action("ReenviarComprobante", "Abono", new { metodo = "whatsapp", transaccionId = transaccion.Id })" 
                                                       class="btn btn-outline-warning" 
                                                       title="Enviar por WhatsApp">
                                                        <i class="fab fa-whatsapp"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted">No se encontraron transacciones</h5>
                                            <p class="text-muted">No hay transacciones que coincidan con los filtros aplicados.</p>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Resumen al pie -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card shadow-sm border-0 bg-light">
                        <div class="card-body text-center">
                            <p class="mb-0 text-muted">
                                <i class="fas fa-info-circle me-2"></i>
                                Documento generado el @DateTime.Now.ToString("dd/MM/yyyy 'a las' HH:mm") | 
                                Sistema de Cobranza de Belleza
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    public string GetEstadoBadgeClass(string estado)
    {
        return estado?.ToLower() switch
        {
            "completado" => "bg-success",
            "procesado" => "bg-primary",
            "activo" => "bg-info",
            "pendiente" => "bg-warning",
            "cancelado" => "bg-secondary",
            "rechazado" => "bg-danger",
            _ => "bg-secondary"
        };
    }
}

<style>
    .card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
    }

    .stat-card {
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: scale(1.05);
    }

    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }

    .bg-gradient-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
    }

    .avatar-circle {
        font-size: 1.2rem;
    }

    .saldo-icon {
        font-size: 1.5rem;
    }

    .table th {
        border-top: none;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }

    .table td {
        vertical-align: middle;
    }

    .btn-group .btn {
        border-radius: 0.375rem;
        margin: 0 2px;
    }

    .badge {
        font-size: 0.75rem;
        padding: 0.35em 0.65em;
    }

    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .btn-group {
            display: flex;
            flex-direction: column;
        }
        
        .btn-group .btn {
            margin: 2px 0;
            border-radius: 0.375rem;
        }
    }
</style>

<!-- Font Awesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">