@model Audicob.Models.Cliente
@{
    ViewData["Title"] = "Buscar Cliente por DNI";
}

<h2 class="mb-4">Buscar Cliente</h2>

@* Renderizamos el token antiforgery en la página para usarlo desde JS *@
@Html.AntiForgeryToken()

<form asp-action="Index" method="post" class="mb-3">
    <div class="form-group mb-3">
        <label for="documento" class="form-label">Documento (DNI):</label>
        <input type="text" id="documento" name="documento" class="form-control" placeholder="Ingrese el número de DNI" required />
    </div>
    <button type="submit" class="btn btn-primary">Evaluar</button>
</form>

@if (ViewBag.Mensaje != null)
{
    <div class="alert alert-warning mt-3">@ViewBag.Mensaje</div>
}

@if (Model != null)
{
    <h3 class="mt-4">Resultado de la búsqueda</h3>
    <table class="table table-bordered table-hover mt-2 align-middle">
        <thead class="table-light">
            <tr>
                <th>Documento (DNI)</th>
                <th>Nombre</th>
                <th>Ingresos Mensuales</th>
                <th>Deuda Total</th>
                <th>Fecha Actualización</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>@Model.Documento</td>
                <td>@Model.Nombre</td>
                <td>@Model.IngresosMensuales.ToString("C")</td>
                <td>@Model.DeudaTotal.ToString("C")</td>
                <td>@Model.FechaActualizacion.ToLocalTime().ToString("dd/MM/yyyy")</td>
                <td>
                    <button class="btn btn-success btn-sm me-2" onclick="accionCliente(@Model.Id, 'aceptar')">
                        <i class="bi bi-check-circle"></i> Aceptar
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="accionCliente(@Model.Id, 'rechazar')">
                        <i class="bi bi-x-circle"></i> Rechazar
                    </button>
                </td>
            </tr>
        </tbody>
    </table>

    <div id="mensajeAccion" class="mt-3"></div>
}

<!-- Nuevo botón para ver lista de clientes rechazados -->
<a asp-controller="ClienteBusqueda" asp-action="ClientesRechazadosPorAdmin" class="btn btn-danger mt-3">
    Ver clientes rechazados por el administrador
</a>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function accionCliente(id, tipo) {
            // URLs explícitas (controlador + acción)
            var urlAceptar = '@Url.Action("AceptarCliente", "ClienteBusqueda")';
            var urlRechazar = '@Url.Action("RechazarCliente", "ClienteBusqueda")';
            var url = tipo === 'aceptar' ? urlAceptar : urlRechazar;

            // tomamos el token antiforgery generado por @Html.AntiForgeryToken()
            var token = $('input[name="__RequestVerificationToken"]').val();

            $.ajax({
                url: url,
                type: 'POST',
                data: { id: id, __RequestVerificationToken: token },
                success: function(data) {
                    if (data && data.success) {
                        $('#mensajeAccion').html('<div class="alert alert-success">' + data.mensaje + '</div>');
                    } else {
                        $('#mensajeAccion').html('<div class="alert alert-danger">' + (data?.mensaje || 'Error en la respuesta') + '</div>');
                    }
                },
                error: function(xhr, status, error) {
                    // Muestra mensaje más detallado si hay info
                    var msg = 'Error al procesar la solicitud.';
                    if (xhr && xhr.responseText) {
                        // intenta parsear JSON devuelto por el servidor
                        try {
                            var json = JSON.parse(xhr.responseText);
                            if (json && json.mensaje) msg = json.mensaje;
                        } catch { /* no JSON */ }
                    }
                    $('#mensajeAccion').html('<div class="alert alert-danger">' + msg + '</div>');
                    console.error('AJAX error:', status, error, xhr);
                }
            });
        }
    </script>
}
