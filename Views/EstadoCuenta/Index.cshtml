@model Audicob.Models.Cliente

@{
    ViewData["Title"] = "Estado de Cuenta";

    var deudas = ViewData["Deudas"] as List<Audicob.Models.Deuda>;
    var pagos = ViewData["Pagos"] as List<Audicob.Models.Pago>;
    var transacciones = ViewData["Transacciones"] as List<Audicob.Models.Transaccion>;
}

<div class="container mt-4">
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h2 class="text-center mb-4">Consultar Estado de Cuenta</h2>

            <!-- 🔹 FORMULARIO DE BÚSQUEDA -->
            <form asp-action="Buscar" method="post" class="row g-3 justify-content-center mb-4">
                <div class="col-md-6">
                    <input type="text" name="documento" class="form-control" placeholder="Ingrese número de documento" required />
                </div>
                <div class="col-md-2 text-center">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                </div>
            </form>

            <!-- Mensaje de error -->
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger text-center">
                    @TempData["Error"]
                </div>
            }

            @if (Model != null)
            {
                <hr />

                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Cliente:</strong> @Model.Nombre</p>
                        <p><strong>Documento:</strong> @Model.Documento</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <p><strong>Deuda Total:</strong> S/ @Model.DeudaTotal</p>
                        <p><strong>Última Actualización:</strong> @Model.FechaActualizacion.ToShortDateString()</p>
                    </div>
                </div>

                <!-- 🔹 BOTÓN SUPERIOR DE PDF -->
                <div class="text-end">
                    <a href="@Url.Action("DescargarPDF", "EstadoCuenta", new { documento = Model.Documento })"
                       class="btn btn-primary mb-3">
                        <i class="bi bi-file-earmark-pdf"></i> Descargar Estado de Cuenta (PDF)
                    </a>
                </div>

                <hr />

                <!-- DEUDAS -->
                <h4 class="mt-4 mb-3 text-secondary">Deudas</h4>
                @if (deudas != null && deudas.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>Monto</th>
                                    <th>Intereses</th>
                                    <th>Penalidad</th>
                                    <th>Total a Pagar</th>
                                    <th>Fecha de Vencimiento</th>
                                    <th>Clasificación</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var d in deudas)
                                {
                                    <tr>
                                        <td>S/ @d.Monto</td>
                                        <td>S/ @d.Intereses</td>
                                        <td>S/ @d.PenalidadCalculada</td>
                                        <td><strong>S/ @d.TotalAPagar</strong></td>
                                        <td>@d.FechaVencimiento.ToShortDateString()</td>
                                        <td>@d.Clasificacion</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-muted">No tienes deudas registradas.</p>
                }

                <!-- PAGOS -->
                <h4 class="mt-5 mb-3 text-secondary">Pagos Realizados</h4>
                @if (pagos != null && pagos.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Monto</th>
                                    <th>Estado</th>
                                    <th>Observación</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var p in pagos)
                                {
                                    <tr>
                                        <td>@p.Fecha.ToShortDateString()</td>
                                        <td>S/ @p.Monto</td>
                                        <td>@p.Estado</td>
                                        <td>@p.Observacion</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-muted">No hay pagos registrados.</p>
                }

                <!-- TRANSACCIONES -->
                <h4 class="mt-5 mb-3 text-secondary">Transacciones</h4>
                @if (transacciones != null && transacciones.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>N° Transacción</th>
                                    <th>Fecha</th>
                                    <th>Monto</th>
                                    <th>Descripción</th>
                                    <th>Estado</th>
                                    <th>Método de Pago</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var t in transacciones)
                                {
                                    <tr>
                                        <td>@t.NumeroTransaccion</td>
                                        <td>@t.Fecha.ToShortDateString()</td>
                                        <td>S/ @t.Monto</td>
                                        <td>@t.Descripcion</td>
                                        <td>@t.Estado</td>
                                        <td>@t.MetodoPago</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-muted">No hay transacciones disponibles.</p>
                }

                <!-- 🔹 BOTÓN INFERIOR DE PDF -->
                <div class="text-end mt-4">
                    <a href="@Url.Action("DescargarPDF", "EstadoCuenta", new { documento = Model.Documento })"
                       class="btn btn-outline-danger">
                        <i class="bi bi-download"></i> Exportar PDF
                    </a>
                </div>
            }
        </div>
    </div>
</div>
