@model Audicob.Models.ViewModels.Supervisor.SupervisorDashboardViewModel

@{
    ViewData["Title"] = "Dashboard Supervisor";
}
<h2 class="mb-4 text-center">Panel de Supervisión - Supervisor</h2>

<!-- Tarjetas resumen -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-bg-primary shadow-sm">
            <div class="card-body text-center">
                <i class="bi bi-person-lines-fill fs-1"></i>
                <h6>Total Clientes</h6>
                <h3>@Model.TotalClientes</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-warning shadow-sm">
            <div class="card-body text-center">
                <i class="bi bi-file-earmark-check fs-1"></i>
                <h6>Evaluaciones Pendientes</h6>
                <h3>@Model.EvaluacionesPendientes</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-danger shadow-sm">
            <div class="card-body text-center">
                <i class="bi bi-wallet fs-1"></i>
                <h6>Deuda Total</h6>
                <h3>S/ @Model.TotalDeuda.ToString("N2")</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-success shadow-sm">
            <div class="card-body text-center">
                <i class="bi bi-cash fs-1"></i>
                <h6>Pagos Último Mes</h6>
                <h3>S/ @Model.TotalPagosUltimoMes.ToString("N2")</h3>
            </div>
        </div>
    </div>
</div>

<!-- Gráficas -->
<div class="row">
    <div class="col-md-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">Pagos últimos 6 meses</div>
            <div class="card-body">
                <canvas id="pagosChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-secondary text-white">Top 5 clientes con más deuda</div>
            <div class="card-body">
                <canvas id="deudasChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Lista de pagos para validar -->
<div class="row mb-4">
    <div class="col-md-12">
        <h3 class="mb-3">Pagos Pendientes para Validación</h3>
        @if (Model.PagosPendientes != null && Model.PagosPendientes.Any())
        {
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Cliente</th>
                        <th>Fecha</th>
                        <th>Monto</th>
                        <th>Estado</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var pago in Model.PagosPendientes)
                    {
                        <tr>
                            <td>@(pago.Cliente?.Nombre ?? "Desconocido")</td>
                            <td>@pago.Fecha.ToString("dd/MM/yyyy")</td>
                            <td>S/ @pago.Monto.ToString("N2")</td>
                            <td>
                                @if (pago.Estado == "Pendiente")
                                {
                                    <span class="badge bg-warning text-dark">Pendiente</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">@pago.Estado</span>
                                }
                            </td>
                            <td>
                                @if (pago.Estado == "Pendiente")
                                {
                                    <form asp-action="ValidarPago" method="post" style="display:inline;">
                                        <input type="hidden" name="pagoId" value="@pago.Id" />
                                        <button type="submit" class="btn btn-success btn-sm">
                                            <i class="bi bi-check-circle"></i> Validar
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <span class="text-muted">Ya validado</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="alert alert-info">
                No hay pagos pendientes de validación.
            </div>
        }
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Gráfico de pagos por mes
        new Chart(document.getElementById('pagosChart'), {
            type: 'line',
            data: {
                labels: @Html.Raw(Json.Serialize(Model.Meses)),
                datasets: [{
                    label: 'Pagos (S/)',
                    data: @Html.Raw(Json.Serialize(Model.PagosPorMes)),
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true }
                }
            }
        });

        // Gráfico de deudas por cliente
        new Chart(document.getElementById('deudasChart'), {
            type: 'bar',
            data: {
                labels: @Html.Raw(Json.Serialize(Model.Clientes)),
                datasets: [{
                    label: 'Deuda (S/)',
                    data: @Html.Raw(Json.Serialize(Model.DeudasPorCliente)),
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true }
                }
            }
        });
    </script>
}