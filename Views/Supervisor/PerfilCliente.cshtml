@model Audicob.Models.ViewModels.Supervisor.PerfilClienteViewModel
@{
    ViewData["Title"] = "Perfil del Cliente";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header mb-4">
                <h1 class="h2">Perfil del Cliente</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a asp-action="Dashboard">Dashboard</a></li>
                        <li class="breadcrumb-item active">Perfil Cliente</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <!-- Información Principal del Cliente -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user me-2"></i>Información Personal
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Nombre Completo</label>
                                <p class="form-control-plaintext">@Model.ClienteInfo.Nombre</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Documento</label>
                                <p class="form-control-plaintext">@Model.ClienteInfo.Documento</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Estado Administrativo</label>
                                <span class="badge @GetEstadoAdminBadgeClass(Model.ClienteInfo.EstadoAdmin)">
                                    @Model.ClienteInfo.EstadoAdmin
                                </span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Ingresos Mensuales</label>
                                <p class="form-control-plaintext">S/ @Model.ClienteInfo.IngresosMensuales.ToString("N2")</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Deuda Total</label>
                                <p class="form-control-plaintext text-danger fw-bold">S/ @Model.ClienteInfo.DeudaTotal.ToString("N2")</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Estado de Mora</label>
                                <span class="badge @GetEstadoMoraBadgeClass(Model.ClienteInfo.EstadoMora)">
                                    @Model.ClienteInfo.EstadoMora
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información Financiera -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>Información Financiera
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <div class="border rounded p-3">
                                <h6 class="text-muted">Total Pagado</h6>
                                <h4 class="text-success">S/ @Model.TotalPagos.ToString("N2")</h4>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="border rounded p-3">
                                <h6 class="text-muted">Pagos Validados</h6>
                                <h4 class="text-primary">@Model.PagosValidados</h4>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="border rounded p-3">
                                <h6 class="text-muted">Pagos Pendientes</h6>
                                <h4 class="text-warning">@Model.PagosPendientes</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transacciones Recientes -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exchange-alt me-2"></i>Transacciones Recientes
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.TransaccionesRecientes.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>N° Transacción</th>
                                        <th>Fecha</th>
                                        <th>Monto</th>
                                        <th>Estado</th>
                                        <th>Método Pago</th>
                                        <th>Descripción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var transaccion in Model.TransaccionesRecientes)
                                    {
                                        <tr>
                                            <td>@transaccion.NumeroTransaccion</td>
                                            <td>@transaccion.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                                            <td class="fw-bold @(transaccion.Monto >= 0 ? "text-success" : "text-danger")">
                                                S/ @transaccion.Monto.ToString("N2")
                                            </td>
                                            <td>
                                                <span class="badge @GetEstadoTransaccionBadgeClass(transaccion.Estado)">
                                                    @transaccion.Estado
                                                </span>
                                            </td>
                                            <td>@transaccion.MetodoPago</td>
                                            <td>@transaccion.Descripcion</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="fas fa-exchange-alt fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No hay transacciones recientes</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Sidebar con Acciones Rápidas -->
        <div class="col-lg-4">
            <!-- Estado de Cartera -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-wallet me-2"></i>Estado de Cartera
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <span class="badge @GetEstadoCarteraBadgeClass(Model.ClienteInfo.EstadoMora) fs-6">
                            @Model.ClienteInfo.EstadoMora
                        </span>
                    </div>
                    <div class="d-grid gap-2">
                        <a asp-action="ModificarEstado" class="btn btn-primary btn-sm">
                            <i class="fas fa-edit me-1"></i>Modificar Estado
                        </a>
                        <a asp-action="DetalleCartera" asp-route-id="@Model.ClienteInfo.Id" 
                           class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-eye me-1"></i>Ver Detalles
                        </a>
                    </div>
                </div>
            </div>

            <!-- Línea de Crédito -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-credit-card me-2"></i>Línea de Crédito
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.ClienteInfo.LineaCredito != null)
                    {
                        <div class="mb-2">
                            <small class="text-muted">Monto Asignado</small>
                            <h5 class="text-success">S/ @Model.ClienteInfo.LineaCredito.Monto.ToString("N2")</h5>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Fecha de Asignación</small>
                            <p>@Model.ClienteInfo.LineaCredito.FechaAsignacion.ToString("dd/MM/yyyy")</p>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Asignado por</small>
                            <p>@Model.ClienteInfo.LineaCredito.UsuarioAsignador</p>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-3">
                            <i class="fas fa-credit-card fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-3">Sin línea de crédito asignada</p>
                            <a asp-action="AsignarLineaCredito" class="btn btn-success btn-sm">
                                <i class="fas fa-plus me-1"></i>Asignar Línea
                            </a>
                        </div>
                    }
                </div>
            </div>

            <!-- Asesor Asignado -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-tie me-2"></i>Asesor Asignado
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.ClienteInfo.AsignacionAsesor != null)
                    {
                        <div class="text-center">
                            <div class="mb-3">
                                <i class="fas fa-user-tie fa-3x text-info"></i>
                            </div>
                            <h6>Asesor Asignado</h6>
                            <p class="text-muted small">ID: @Model.ClienteInfo.AsignacionAsesor.Id</p>
                            <span class="badge bg-success">Asignado</span>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-3">
                            <i class="fas fa-user-tie fa-2x text-muted mb-2"></i>
                            <p class="text-muted">Sin asesor asignado</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Acciones Rápidas -->
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Acciones Rápidas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a asp-action="VerInformeFinanciero" asp-route-id="@Model.ClienteInfo.Id" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-file-invoice me-1"></i>Ver Informe Financiero
                        </a>
                        <a href="#" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-history me-1"></i>Historial de Pagos
                        </a>
                        <a href="#" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-chart-bar me-1"></i>Reportes
                        </a>
                        <a asp-action="Dashboard" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>Volver al Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    // Función para obtener la clase del badge según el estado administrativo
    public string GetEstadoAdminBadgeClass(string estado)
    {
        return estado?.ToLower() switch
        {
            "activo" or "aceptado" => "bg-success",
            "pendiente" => "bg-warning",
            "rechazado" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    // Función para obtener la clase del badge según el estado de mora
    public string GetEstadoMoraBadgeClass(string estadoMora)
    {
        return estadoMora?.ToLower() switch
        {
            "al día" => "bg-success",
            "temprana" => "bg-info",
            "moderada" => "bg-warning",
            "grave" or "crítica" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    // Función para obtener la clase del badge según el estado de transacción
    public string GetEstadoTransaccionBadgeClass(string estado)
    {
        return estado?.ToLower() switch
        {
            "completado" or "validado" => "bg-success",
            "pendiente" => "bg-warning",
            "fallido" or "cancelado" or "rechazado" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    // Función para obtener la clase del badge según el estado de cartera
    public string GetEstadoCarteraBadgeClass(string estado)
    {
        return estado?.ToLower() switch
        {
            "vigente" or "al día" => "bg-success",
            "temprana" => "bg-info",
            "morosa" or "moderada" => "bg-warning",
            "castigada" or "grave" or "crítica" => "bg-danger",
            _ => "bg-secondary"
        };
    }
}

@section Styles {
    <style>
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 1.5rem;
        }

        .card-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
            font-weight: 600;
        }

        .form-control-plaintext {
            padding: 0.375rem 0;
            margin-bottom: 0;
            line-height: 1.5;
            background-color: transparent;
            border: solid transparent;
            border-width: 1px 0;
        }

        .badge {
            font-size: 0.75em;
            font-weight: 600;
        }

        .table th {
            border-top: none;
            font-weight: 600;
            color: #6c757d;
            font-size: 0.875rem;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
    </style>
}