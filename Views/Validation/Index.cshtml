@model Audicob.Models.DashboardViewModel

<div class="container-fluid">
    <!-- Men√∫ de Validaci√≥n -->
    <div class="row mb-4">
        <div class="col-12">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="navbar-nav">
                    <a class="nav-link active" href="#">Validar Pagos</a>
                    <a class="nav-link" href="#" id="syncAllButton">Sincronizaci√≥n</a>
                    <a class="nav-link" href="@Url.Action("Dashboard")">Dashboard Datos</a>
                    <a class="nav-link" href="#">Gesti√≥n Clientes</a>
                    <a class="nav-link" href="#">Configuraci√≥n</a>
                    <a class="nav-link" href="#">Ayuda</a>
                </div>
            </nav>
            <hr />
        </div>
    </div>

    <!-- Mensajes del sistema -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["InfoMessage"] != null)
    {
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="bi bi-info-circle-fill"></i> @TempData["InfoMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <!-- Columna izquierda: Estad√≠sticas y Clientes -->
        <div class="col-md-8">
            <!-- Estad√≠sticas -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Estad√≠sticas de Validaci√≥n</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="display-4 text-success">@Model.Metrics.ValidPercentage.ToString("F0")%</div>
                            <div class="text-muted">Datos V√°lidos</div>
                        </div>
                        <div class="col-md-3">
                            <div class="display-4 text-danger">@Model.Metrics.ErrorPercentage.ToString("F0")%</div>
                            <div class="text-muted">Con Errores</div>
                        </div>
                        <div class="col-md-3">
                            <div class="display-4 text-primary">@Model.Metrics.TotalClientes</div>
                            <div class="text-muted">Total Clientes</div>
                        </div>
                        <div class="col-md-3">
                            <div class="display-4 text-warning">@Model.Metrics.PendientesSincronizacion</div>
                            <div class="text-muted">Pendientes Sinc.</div>
                        </div>
                    </div>
                    <div class="mt-3 text-center">
                        <small class="text-muted">Total de registros procesados: @Model.Metrics.TotalRecords</small>
                    </div>
                </div>
            </div>

            <!-- Alertas -->
            <div class="card mb-4">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="bi bi-bell-fill"></i> Alertas Recientes</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="display-4 text-warning">@Model.Metrics.PendingAlerts</div>
                            <div class="text-muted">Pendientes</div>
                        </div>
                        <div class="col-md-4">
                            <div class="display-4 text-success">@Model.Metrics.ResolvedAlerts</div>
                            <div class="text-muted">Resueltas</div>
                        </div>
                        <div class="col-md-4">
                            <div class="display-4 text-info">@Model.Metrics.ClientesAlDia</div>
                            <div class="text-muted">Clientes al D√≠a</div>
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted">√öltima alerta: @Model.Metrics.LastAlert</small>
                    </div>
                </div>
            </div>

            <!-- Clientes Recientes -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-people-fill"></i> Clientes Recientes</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th>Documento</th>
                                    <th>Nombre</th>
                                    <th>Deuda Total</th>
                                    <th>Estado Mora</th>
                                    <th>Estado Admin</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var cliente in Model.ClientesRecientes)
                                {
                                    <tr>
                                        <td><strong>@cliente.Documento</strong></td>
                                        <td>@cliente.Nombre</td>
                                        <td class="fw-bold">@cliente.DeudaTotal.ToString("C")</td>
                                        <td>
                                            <span class="badge @(cliente.EstadoMora == "Al d√≠a" ? "bg-success" : "bg-warning")">
                                                @cliente.EstadoMora
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge @(cliente.EstadoAdmin == "Aceptado" ? "bg-success" : 
                                                       cliente.EstadoAdmin == "Rechazado" ? "bg-danger" : "bg-secondary")">
                                                @cliente.EstadoAdmin
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna derecha: Formulario y Validaciones Recientes -->
        <div class="col-md-4">
            <!-- Formulario de Validaci√≥n -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-check-square-fill"></i> Validar Registro de Pago</h5>
                </div>
                <div class="card-body">
                    <form asp-action="ValidateData" method="post" id="validationForm" novalidate>
                        @Html.AntiForgeryToken()
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Documento / DNI *</label>
                            <input type="text" name="ClientId" class="form-control" 
                                   placeholder="Ej: 12345678" value="" required />
                            <small class="text-muted">Usar: 12345678, 87654321 o 11223344</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">N√∫mero de Voucher *</label>
                            <input type="text" name="VoucherNumber" class="form-control" 
                                   placeholder="VOUCHER001" value="" required />
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Monto del Pago *</label>
                            <input type="number" name="PaymentAmount" step="0.01" min="0.01"
                                   class="form-control" placeholder="1000.00" value="" required />
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Fecha de Pago *</label>
                            <input type="date" name="PaymentDate" class="form-control" 
                                   id="paymentDateInput" required />
                        </div>

                        <button type="submit" class="btn btn-primary w-100 btn-lg">
                            <i class="bi bi-check-circle"></i> Validar Datos
                        </button>
                    </form>
                </div>
            </div>

            <!-- Validaciones Recientes -->
            <div class="card">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="bi bi-clock-history"></i> Validaciones Recientes</h6>
                    <span class="badge bg-warning">@Model.Metrics.PendientesSincronizacion pendientes</span>
                </div>
                <div class="card-body">
                    @if (Model.RecentValidations != null && Model.RecentValidations.Any())
                    {
                        @foreach (var validation in Model.RecentValidations)
                        {
                            <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded bg-light">
                                <div class="flex-grow-1">
                                    <strong class="d-block text-primary">@validation.Cliente?.Nombre</strong>
                                    <small class="text-muted d-block">Documento: @validation.ClientId</small>
                                    <small class="text-muted d-block">Voucher: <strong>@validation.VoucherNumber</strong></small>
                                    <small class="text-muted d-block">Monto: <strong>@validation.PaymentAmount.ToString("C")</strong></small>
                                    <small class="text-muted">@validation.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                </div>
                                <div class="ms-3 text-center">
                                    @if (validation.Status == Audicob.Models.ValidationStatus.Validated)
                                    {
                                        <form asp-action="Synchronize" method="post" class="sync-form">
                                            <input type="hidden" name="id" value="@validation.Id" />
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-success btn-sm">
                                                <i class="bi bi-arrow-repeat"></i> Sincronizar
                                            </button>
                                        </form>
                                        <small class="text-muted d-block mt-1">Pendiente</small>
                                    }
                                    else if (validation.Status == Audicob.Models.ValidationStatus.Synchronized)
                                    {
                                        <span class="badge bg-success p-2">
                                            <i class="bi bi-check-lg"></i> Sincronizado
                                        </span>
                                        <small class="text-muted d-block mt-1">
                                            @validation.SynchronizedAt?.ToString("dd/MM/yyyy HH:mm")
                                        </small>
                                    }
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-inbox display-4"></i>
                            <p class="mb-1 fw-bold">No hay validaciones recientes</p>
                            <small>Las validaciones aparecer√°n aqu√≠ despu√©s de procesar pagos</small>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Establecer fecha actual por defecto
            var today = new Date().toISOString().split('T')[0];
            document.getElementById('paymentDateInput').value = today;

            // Debug: Mostrar cuando se env√≠a el formulario
            $('#validationForm').on('submit', function(e) {
                console.log('üîç Formulario de validaci√≥n enviado');
                return true;
            });

            // Sincronizaci√≥n individual con confirmaci√≥n
            $(document).on('submit', '.sync-form', function(e) {
                e.preventDefault();
                var form = $(this);
                var clienteNombre = form.closest('.d-flex').find('.text-primary').text();
                
                if (confirm(`¬øEst√°s seguro de que quieres sincronizar el pago de ${clienteNombre}?`)) {
                    console.log('‚úÖ Confirmado - Enviando formulario de sincronizaci√≥n...');
                    form.off('submit').submit();
                } else {
                    console.log('‚ùå Sincronizaci√≥n cancelada');
                }
            });

            // Sincronizaci√≥n masiva
            $('#syncAllButton').click(function(e) {
                e.preventDefault();
                var pendientes = @Model.Metrics.PendientesSincronizacion;
                
                if (pendientes > 0) {
                    if (confirm(`¬øSincronizar todos los ${pendientes} pagos pendientes?`)) {
                        // Crear formulario para sincronizaci√≥n masiva
                        var form = $('<form>', {
                            'action': '@Url.Action("SynchronizeAll")',
                            'method': 'post'
                        });
                        
                        var token = $('input[name="__RequestVerificationToken"]').first().clone();
                        form.append(token);
                        $('body').append(form);
                        form.submit();
                    }
                } else {
                    alert('No hay pagos pendientes para sincronizar');
                }
            });
        });
    </script>
}